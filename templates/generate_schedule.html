<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rota Management & AI Validation</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2d3748;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-header p {
            color: #64748b;
            font-size: 1.1rem;
            font-weight: 400;
        }

        /* Flash Messages */
        .flash-messages {
            margin-bottom: 30px;
        }

        .flash {
            padding: 16px 24px;
            border-radius: 16px;
            margin-bottom: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.5s ease-out;
            border: 1px solid transparent;
        }

        .flash.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .flash.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        .flash.info {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .flash.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
        }

        /* Form Styling */
        .form-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .form-section h3 {
            color: #1e293b;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .form-section h3 i {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 16px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
            font-size: 0.95rem;
        }

        select, input[type="number"] {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            margin-bottom: 20px;
        }

        select:focus, input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Button Styling */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-height: 52px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(239, 68, 68, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(245, 158, 11, 0.4);
        }

        .btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* AI Validation Report */
        .validation-report {
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .validation-report::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
        }

        .validation-report.valid {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-color: #10b981;
            color: #065f46;
        }

        .validation-report.valid::before {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .validation-report.invalid {
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            border-color: #ef4444;
            color: #991b1b;
        }

        .validation-report.invalid::before {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .validation-report h4 {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .validation-report ul {
            margin-left: 20px;
            margin-bottom: 20px;
        }

        .validation-report li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 20px;
            margin: 30px 0;
            border: 2px solid #e2e8f0;
        }

        .spinner {
            border: 4px solid #f1f5f9;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1.5s linear infinite;
            margin: 0 auto 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-indicator {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.95rem;
            color: #4c51bf;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        /* Schedule Display */
        .schedule-section {
            margin-top: 30px;
        }

        .schedule-section h4 {
            color: #1e293b;
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 25px;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 16px;
            border: 1px solid #e2e8f0;
        }

        .shift-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .shift-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .shift-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .shift-card h4 {
            margin: 0;
            padding: 20px 25px;
            color: #fff;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-section {
            padding: 25px;
        }

        .card-section:nth-child(even) {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .card-section h5 {
            font-size: 0.9rem;
            text-transform: uppercase;
            color: #64748b;
            margin-bottom: 15px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .employee-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .employee-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .employee-list li:last-child {
            border-bottom: none;
        }

        .employee-list li:hover {
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
            padding-left: 10px;
            padding-right: 10px;
        }

        .employee-name {
            font-weight: 600;
            color: #1e293b;
        }

        .employee-designation {
            font-size: 0.85rem;
            color: #64748b;
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 500;
        }

        .no-data-text {
            color: #94a3b8;
            font-style: italic;
            font-size: 0.9rem;
            text-align: center;
            padding: 20px;
        }

        /* Enhanced Change Highlighting */
        .employee-moved {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
            color: white !important;
            border: 2px solid #10b981 !important;
            border-radius: 12px !important;
            padding: 15px 20px !important;
            margin: 8px 0 !important;
            animation: highlight-glow-green 3s ease-in-out;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
            transform: scale(1.03);
            font-weight: bold;
        }

        .employee-moved .employee-designation {
            background: rgba(255, 255, 255, 0.25) !important;
            color: white !important;
        }

        @keyframes highlight-glow-green {
            0% {
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
                transform: scale(1);
            }
            50% {
                background: linear-gradient(135deg, #059669 0%, #047857 100%);
                box-shadow: 0 12px 35px rgba(16, 185, 129, 0.6);
                transform: scale(1.05);
            }
            100% {
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
                transform: scale(1.03);
            }
        }

        .change-badge {
            background: rgba(255, 255, 255, 0.9);
            color: #059669;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 4px 10px;
            border-radius: 20px;
            margin-left: 10px;
            animation: pulse-badge 2s ease-in-out;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        @keyframes pulse-badge {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .violations-fixed {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #10b981;
            border-radius: 16px;
            padding: 25px;
            margin: 25px 0;
            color: #065f46;
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            0% { opacity: 0; transform: translateY(-20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .violations-fixed h5 {
            margin-top: 0;
            color: #065f46;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .violations-fixed ul {
            margin-bottom: 0;
            padding-left: 25px;
        }

        .violations-fixed li {
            margin-bottom: 10px;
            position: relative;
            line-height: 1.5;
        }

        .violations-fixed li::before {
            content: "‚úì";
            position: absolute;
            left: -20px;
            color: #10b981;
            font-weight: bold;
            font-size: 1.1rem;
        }

        /* Download Section */
        .download-section {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
            border: 2px solid #e2e8f0;
        }

        .download-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 15px;
        }

        .download-info {
            font-size: 0.9rem;
            color: #64748b;
            font-style: italic;
            margin-top: 10px;
        }

        /* Back Link */
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 40px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
        }

        .back-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 114, 128, 0.4);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 30px 20px;
            }

            .page-header h1 {
                font-size: 2rem;
            }

            .shift-cards-container {
                grid-template-columns: 1fr;
            }

            .download-buttons {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                justify-content: center;
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .swap-animation {
            animation: swap-highlight 4s ease-in-out;
        }

        @keyframes swap-highlight {
            0% { transform: translateX(0) scale(1); }
            25% { transform: translateX(10px) scale(1.03); background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
            50% { transform: translateX(-10px) scale(1.03); background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
            75% { transform: translateX(5px) scale(1.03); background: linear-gradient(135deg, #059669 0%, #047857 100%); }
            100% { transform: translateX(0) scale(1.03); background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-calendar-alt"></i> Rota Management & AI Validation</h1>
            <p>Intelligent shift scheduling with AI-powered optimization and validation</p>
        </div>
        
        <!-- Flash Messages Container -->
        <div id="flash-messages" class="flash-messages">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% for category, message in messages %}
                    <div class="flash {{ category }}">
                        {% if category == 'success' %}
                            <i class="fas fa-check-circle"></i>
                        {% elif category == 'danger' %}
                            <i class="fas fa-exclamation-triangle"></i>
                        {% elif category == 'info' %}
                            <i class="fas fa-info-circle"></i>
                        {% elif category == 'warning' %}
                            <i class="fas fa-exclamation-circle"></i>
                        {% endif %}
                        {{ message }}
                    </div>
                {% endfor %}
            {% endwith %}
        </div>

        <!-- Team Selection Form -->
        <div class="form-section">
            <h3><i class="fas fa-users"></i> Team Selection</h3>
            <form method="GET" id="team-select-form">
                <label for="team_id_select">Select a Team to View or Manage Schedule:</label>
                <select id="team_id_select" name="team_id" onchange="this.form.submit()">
                    <option value="">-- Choose a team --</option>
                    {% for team in teams %}
                        <option value="{{ team.id }}" {% if selected_team and team.id == selected_team.id %}selected{% endif %}>
                            {{ team.name }}
                        </option>
                    {% endfor %}
                </select>
            </form>
        </div>

        <!-- This section will only show if a team has been selected -->
        {% if selected_team %}
            
            <!-- If a schedule EXISTS, show it and the management options -->
            {% if schedule_exists %}
                <div class="form-section">
                    <h3><i class="fas fa-clipboard-check"></i> Existing Schedule for {{ selected_team.name }}</h3>
                    
                    <!-- AI Validation Report Card -->
                    <div id="validation-report-container">
                        {% if ai_validation_report %}
                            <div class="validation-report {% if ai_validation_report.is_valid %}valid{% else %}invalid{% endif %}" id="validation-card">
                                <h4 id="validation-status">
                                    <i class="fas fa-robot"></i>
                                    AI Validation Status: 
                                    {% if ai_validation_report.is_valid %}
                                        <i class="fas fa-check-circle"></i> All Rules Passed
                                    {% else %}
                                        <i class="fas fa-exclamation-triangle"></i> Violations Found
                                    {% endif %}
                                </h4>
                                <div id="violations-container">
                                    {% if ai_validation_report.violations %}
                                        <p><strong>Issues detected:</strong></p>
                                        <ul id="violations-list">
                                            {% for issue in ai_validation_report.violations %}
                                                <li>{{ issue }}</li>
                                            {% endfor %}
                                        </ul>
                                        <!-- AJAX Fix Button -->
                                        <button type="button" id="fix-schedule-btn" class="btn btn-warning" onclick="fixScheduleWithAI()">
                                            <i class="fas fa-wrench"></i> Fix Issues with AI
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Container for violations that were fixed -->
                    <div id="fixed-violations-container" style="display: none;">
                        <div class="violations-fixed">
                            <h5><i class="fas fa-check-circle"></i> Issues Successfully Fixed by AI:</h5>
                            <ul id="fixed-violations-list"></ul>
                        </div>
                    </div>

                    <!-- Loading Spinner with Progress -->
                    <div id="loading-spinner" class="loading-spinner">
                        <div class="spinner"></div>
                        <p><strong>AI is analyzing and fixing your schedule...</strong></p>
                        <div class="progress-indicator">
                            <div id="progress-text"><i class="fas fa-search"></i> Analyzing violations and planning optimal swaps...</div>
                        </div>
                    </div>

                    <!-- Download Options -->
                    <div class="download-section">
                        <div class="download-buttons">
                            <a href="{{ url_for('main.download_schedule_csv', team_id=selected_team.id) }}" class="btn btn-success">
                                <i class="fas fa-download"></i> Download CSV (Simple)
                            </a>
                            <a href="{{ url_for('main.download_schedule_detailed_csv', team_id=selected_team.id) }}" class="btn btn-success">
                                <i class="fas fa-chart-line"></i> Download CSV (Detailed)
                            </a>
                        </div>
                        <div class="download-info">
                            <i class="fas fa-info-circle"></i> Export schedule data for external use or analysis
                        </div>
                    </div>

                    <form action="{{ url_for('main.delete_schedule', team_id=selected_team.id) }}" method="POST" onsubmit="return confirm('Are you sure? This will delete the schedule permanently.');">
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash-alt"></i> Delete This Schedule
                        </button>
                    </form>
                </div>

                <!-- Schedule Display Container -->
                <div id="schedule-container" class="schedule-section">
                    {% set shift_order = ['Early Morning', 'Morning', 'Afternoon', 'Evening', 'Night'] %}
                    {% for month_name, shifts in schedule_by_month.items() %}
                        <h4 data-month="{{ month_name }}"><i class="fas fa-calendar-month"></i> {{ month_name }}</h4>
                        <div class="shift-cards-container" data-month="{{ month_name }}">
                            {% for shift_name in shift_order %}
                                {% if shift_name in shifts %}
                                    {% set data = shifts[shift_name] %}
                                    <div class="shift-card" data-shift="{{ shift_name }}" data-month="{{ month_name }}">
                                        <h4>
                                            {% if shift_name == 'Early Morning' %}
                                                <i class="fas fa-sun"></i>
                                            {% elif shift_name == 'Morning' %}
                                                <i class="fas fa-cloud-sun"></i>
                                            {% elif shift_name == 'Afternoon' %}
                                                <i class="fas fa-sun"></i>
                                            {% elif shift_name == 'Evening' %}
                                                <i class="fas fa-cloud-moon"></i>
                                            {% else %}
                                                <i class="fas fa-moon"></i>
                                            {% endif %}
                                            {{ shift_name }} Shift
                                        </h4>
                                        <div class="card-section">
                                            <h5><i class="fas fa-user-tie"></i> Fixed Staff</h5>
                                            <ul class="employee-list" data-section="assigned_staff" data-shift="{{ shift_name }}" data-month="{{ month_name }}">
                                                {% for employee in data.assigned_staff %}
                                                <li data-employee="{{ employee.name }}" data-month="{{ month_name }}" data-shift="{{ shift_name }}" data-section="assigned_staff">
                                                    <span class="employee-name">{{ employee.name }}</span>
                                                    <span class="employee-designation">{{ employee.designation }}</span>
                                                </li>
                                                {% else %}
                                                <li class="no-staff-indicator">
                                                    <span class="no-data-text"><i class="fas fa-exclamation-circle"></i> Understaffed</span>
                                                </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="card-section">
                                            <h5><i class="fas fa-users-cog"></i> Designated Floaters</h5>
                                            <ul class="employee-list" data-section="floaters" data-shift="{{ shift_name }}" data-month="{{ month_name }}">
                                                {% for floater in data.floaters %}
                                                <li data-employee="{{ floater.name }}" data-month="{{ month_name }}" data-shift="{{ shift_name }}" data-section="floaters">
                                                    <span class="employee-name">{{ floater.name }}</span>
                                                    <span class="employee-designation">{{ floater.designation }}</span>
                                                </li>
                                                {% else %}
                                                <li class="no-floaters-indicator">
                                                    <span class="no-data-text"><i class="fas fa-user-slash"></i> No Floaters Assigned</span>
                                                </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>

            <!-- If no schedule exists, show the generation form -->
            {% else %}
                <div class="form-section">
                    <h3><i class="fas fa-plus-circle"></i> Generate New Schedule for {{ selected_team.name }}</h3>
                    <form action="{{ url_for('main.generate_schedule') }}" method="POST">
                        <input type="hidden" name="team_id" value="{{ selected_team.id }}">
                        
                        <label for="months"><i class="fas fa-calendar-alt"></i> Number of Months to Generate:</label>
                        <input type="number" id="months" name="months" min="1" max="12" value="1" required>

                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-magic"></i> Generate & Save Schedule
                        </button>
                    </form>
                </div>
            {% endif %}
        {% endif %}

        <a href="{{ url_for('main.dashboard') }}" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <script>
        let progressMessages = [
            "üîç Analyzing violations and planning optimal swaps...",
            "üîÑ Finding compatible employees for swapping...",
            "‚öñÔ∏è Testing swaps to ensure no new violations...",
            "‚ú® Finalizing optimized schedule..."
        ];
        let progressIndex = 0;
        let progressInterval;
        
        function fixScheduleWithAI() {
            const fixBtn = document.getElementById('fix-schedule-btn');
            const loadingSpinner = document.getElementById('loading-spinner');
            const progressText = document.getElementById('progress-text');
            const fixedViolationsContainer = document.getElementById('fixed-violations-container');
            
            // Show loading, disable button
            fixBtn.disabled = true;
            fixBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fixing in progress...';
            loadingSpinner.style.display = 'block';
            fixedViolationsContainer.style.display = 'none';
            
            // Start progress indicator
            progressIndex = 0;
            progressInterval = setInterval(() => {
                if (progressIndex < progressMessages.length - 1) {
                    progressIndex++;
                    progressText.innerHTML = `<i class="fas fa-cog fa-spin"></i> ${progressMessages[progressIndex]}`;
                }
            }, 2000);
            
            // Make AJAX request
            fetch(`/fix_schedule/{{ selected_team.id if selected_team else 0 }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                // Clear progress interval
                clearInterval(progressInterval);
                
                // Hide loading spinner
                loadingSpinner.style.display = 'none';
                
                if (data.success) {
                    // Show success message
                    showFlashMessage(data.message, 'success');
                    
                    // Check if no changes were possible
                    if (data.no_changes_possible) {
                        // Update validation report to show optimal status
                        updateValidationReportOptimal();
                        return;
                    }
                    
                    // Show fixed violations if any
                    if (data.violations_fixed && data.violations_fixed.length > 0) {
                        showFixedViolations(data.violations_fixed);
                    }
                    
                    // Update the schedule display with highlighting - THIS IS THE KEY PART
                    if (data.schedule && data.changes_made && data.changes_made.length > 0) {
                        updateScheduleDisplayWithSwaps(data.schedule, data.changes_made);
                    }
                    
                    // Update validation report
                    updateValidationReport(data.validation_report);
                    
                } else {
                    // Show error message
                    showFlashMessage(data.error || 'Failed to fix schedule', 'danger');
                    
                    // Re-enable button
                    fixBtn.disabled = false;
                    fixBtn.innerHTML = '<i class="fas fa-wrench"></i> Fix Issues with AI';
                }
            })
            .catch(error => {
                // Clear progress interval
                clearInterval(progressInterval);
                
                // Hide loading spinner
                loadingSpinner.style.display = 'none';
                
                // Show error message
                showFlashMessage('An error occurred while fixing the schedule. Please try again.', 'danger');
                
                // Re-enable button
                fixBtn.disabled = false;
                fixBtn.innerHTML = '<i class="fas fa-wrench"></i> Fix Issues with AI';
                
                console.error('Error:', error);
            });
        }
        
        function showFlashMessage(message, category) {
            const flashContainer = document.getElementById('flash-messages');
            const flashDiv = document.createElement('div');
            flashDiv.className = `flash ${category}`;
            
            // Add appropriate icon based on category
            let icon = '';
            switch(category) {
                case 'success':
                    icon = '<i class="fas fa-check-circle"></i>';
                    break;
                case 'danger':
                    icon = '<i class="fas fa-exclamation-triangle"></i>';
                    break;
                case 'info':
                    icon = '<i class="fas fa-info-circle"></i>';
                    break;
                case 'warning':
                    icon = '<i class="fas fa-exclamation-circle"></i>';
                    break;
            }
            
            flashDiv.innerHTML = `${icon} ${message}`;
            
            // Clear existing messages
            flashContainer.innerHTML = '';
            flashContainer.appendChild(flashDiv);
            
            // Scroll to top to show the message
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Auto-remove after 8 seconds
            setTimeout(() => {
                if (flashDiv.parentNode) {
                    flashDiv.remove();
                }
            }, 8000);
        }
        
        function showFixedViolations(fixedViolations) {
            const container = document.getElementById('fixed-violations-container');
            const list = document.getElementById('fixed-violations-list');
            
            // Clear existing content
            list.innerHTML = '';
            
            // Add each fixed violation
            fixedViolations.forEach(violation => {
                const listItem = document.createElement('li');
                listItem.textContent = violation;
                list.appendChild(listItem);
            });
            
            // Show the container with animation
            container.style.display = 'block';
            
            // Auto-hide after 15 seconds
            setTimeout(() => {
                container.style.display = 'none';
            }, 15000);
        }
        
        function updateScheduleDisplayWithSwaps(newSchedule, changes) {
            console.log('Updating schedule with swaps:', changes);
            
            // First, update the actual schedule data
            updateScheduleData(newSchedule);
            
            // Then highlight the changes
            setTimeout(() => {
                highlightSwapChanges(changes);
            }, 500);
        }
        
        function updateScheduleData(newSchedule) {
            // Process each month in the new schedule
            Object.keys(newSchedule).forEach(monthName => {
                const monthShifts = newSchedule[monthName];
                
                // Process each shift in the month
                Object.keys(monthShifts).forEach(shiftName => {
                    const shiftData = monthShifts[shiftName];
                    
                    // Update assigned staff
                    updateEmployeeSection(monthName, shiftName, 'assigned_staff', shiftData.assigned_staff || []);
                    
                    // Update floaters
                    updateEmployeeSection(monthName, shiftName, 'floaters', shiftData.floaters || []);
                });
            });
        }
        
        function updateEmployeeSection(monthName, shiftName, sectionType, newEmployees) {
            const listSelector = `ul[data-month="${monthName}"][data-shift="${shiftName}"][data-section="${sectionType}"]`;
            const employeeList = document.querySelector(listSelector);
            
            if (!employeeList) {
                console.warn(`Could not find employee list for ${monthName}-${shiftName}-${sectionType}`);
                return;
            }
            
            // Clear the list
            employeeList.innerHTML = '';
            
            if (newEmployees && newEmployees.length > 0) {
                newEmployees.forEach(employee => {
                    const li = document.createElement('li');
                    li.setAttribute('data-employee', employee.name);
                    li.setAttribute('data-month', monthName);
                    li.setAttribute('data-shift', shiftName);
                    li.setAttribute('data-section', sectionType);
                    
                    li.innerHTML = `
                        <span class="employee-name">${employee.name}</span>
                        <span class="employee-designation">${employee.designation}</span>
                    `;
                    
                    employeeList.appendChild(li);
                });
            } else {
                // Add appropriate "no data" message
                const li = document.createElement('li');
                li.className = sectionType === 'assigned_staff' ? 'no-staff-indicator' : 'no-floaters-indicator';
                
                const span = document.createElement('span');
                span.className = 'no-data-text';
                
                if (sectionType === 'assigned_staff') {
                    span.innerHTML = '<i class="fas fa-exclamation-circle"></i> Understaffed';
                } else {
                    span.innerHTML = '<i class="fas fa-user-slash"></i> No Floaters Assigned';
                }
                
                li.appendChild(span);
                employeeList.appendChild(li);
            }
        }
        
        function highlightSwapChanges(changes) {
            console.log('Highlighting changes:', changes);
            
            // Group changes by employee to handle swaps properly
            const employeeChanges = new Map();
            
            changes.forEach(change => {
                if (!employeeChanges.has(change.employee)) {
                    employeeChanges.set(change.employee, []);
                }
                employeeChanges.get(change.employee).push(change);
            });
            
            // Apply highlighting to each changed employee
            employeeChanges.forEach((employeeChangeList, employeeName) => {
                employeeChangeList.forEach(change => {
                    // Find the employee in their NEW position
                    const employeeElement = document.querySelector(
                        `li[data-employee="${change.employee}"][data-month="${change.month}"][data-shift="${change.shift}"][data-section="${change.section}"]`
                    );
                    
                    if (employeeElement) {
                        // Add highlighting class
                        employeeElement.classList.add('employee-moved', 'swap-animation');
                        
                        // Add change badge
                        const badge = document.createElement('span');
                        badge.className = 'change-badge';
                        badge.textContent = 'MOVED';
                        employeeElement.appendChild(badge);
                        
                        // Remove highlighting after animation
                        setTimeout(() => {
                            if (employeeElement) {
                                employeeElement.classList.remove('swap-animation');
                                // Keep the green highlighting for longer visibility
                                setTimeout(() => {
                                    employeeElement.classList.remove('employee-moved');
                                    if (badge && badge.parentNode) {
                                        badge.remove();
                                    }
                                }, 8000);
                            }
                        }, 4000);
                        
                        console.log(`Highlighted ${change.employee} in ${change.month} ${change.shift}`);
                    } else {
                        console.warn(`Could not find element for ${change.employee} in ${change.month} ${change.shift}`);
                    }
                });
            });
        }
        
        function updateValidationReport(validationReport) {
            if (!validationReport) return;
            
            const validationCard = document.getElementById('validation-card');
            const validationStatus = document.getElementById('validation-status');
            const violationsContainer = document.getElementById('violations-container');
            const fixBtn = document.getElementById('fix-schedule-btn');
            
            if (validationReport.is_valid) {
                // Update card style
                validationCard.className = 'validation-report valid';
                
                // Update status
                validationStatus.innerHTML = '<i class="fas fa-robot"></i> AI Validation Status: <i class="fas fa-check-circle"></i> All Rules Passed';
                
                // Hide violations container
                violationsContainer.innerHTML = '<p><strong><i class="fas fa-check-circle"></i> All scheduling rules are now compliant!</strong></p>';
                
                // Hide fix button
                if (fixBtn) {
                    fixBtn.style.display = 'none';
                }
                
            } else {
                // Update card style
                validationCard.className = 'validation-report invalid';
                
                // Update status
                validationStatus.innerHTML = '<i class="fas fa-robot"></i> AI Validation Status: <i class="fas fa-exclamation-triangle"></i> Some Issues Remain';
                
                // Update violations list
                if (validationReport.violations && validationReport.violations.length > 0) {
                    let violationsHTML = '<p><strong>Remaining issues:</strong></p><ul>';
                    validationReport.violations.forEach(violation => {
                        violationsHTML += `<li>${violation}</li>`;
                    });
                    violationsHTML += '</ul>';
                    violationsHTML += '<p><em><i class="fas fa-info-circle"></i> These issues may require manual intervention.</em></p>';
                    
                    violationsContainer.innerHTML = violationsHTML;
                    
                    // Re-enable fix button if there are still violations
                    if (fixBtn) {
                        fixBtn.style.display = 'block';
                        fixBtn.disabled = false;
                        fixBtn.innerHTML = '<i class="fas fa-wrench"></i> Fix Remaining Issues with AI';
                    }
                } else {
                    violationsContainer.innerHTML = '<p><strong><i class="fas fa-check-circle"></i> All issues have been resolved!</strong></p>';
                    if (fixBtn) {
                        fixBtn.style.display = 'none';
                    }
                }
            }
        }
        
        function updateValidationReportOptimal() {
            const validationCard = document.getElementById('validation-card');
            const validationStatus = document.getElementById('validation-status');
            const violationsContainer = document.getElementById('violations-container');
            const fixBtn = document.getElementById('fix-schedule-btn');
            
            // Update card style to valid
            validationCard.className = 'validation-report valid';
            
            // Update status
            validationStatus.innerHTML = '<i class="fas fa-robot"></i> AI Validation Status: <i class="fas fa-check-circle"></i> Schedule is Already Optimal';
            
            // Update content
            violationsContainer.innerHTML = '<p><strong><i class="fas fa-check-circle"></i> No violations found - schedule is already optimal!</strong></p>';
            
            // Remove fix button since it's not needed
            if (fixBtn) {
                fixBtn.style.display = 'none';
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Schedule management page loaded and ready for AI fixes');
            
            // Add smooth scrolling to all anchor links
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
        });
    </script>
</body>
</html>